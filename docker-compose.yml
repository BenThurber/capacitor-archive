version: '3.3'
services:
    
    prodDatabase:
        image: 'mysql:8.0.22'
        container_name: prod-mysql
        restart: always
        ports:
            - '3306:3306'
        environment:
                MYSQL_DATABASE: capacitor_prod
        env_file:
            - mysql.env
    

    testDatabase:
        image: 'mysql:8.0.22'
        container_name: test-mysql
        restart: always
        ports:
            - '3307:3306'
        environment:
                MYSQL_DATABASE: capacitor_test
        env_file:
            - mysql.env
    

    testDatabaseBackup:
        image: 'databack/mysql-backup'
        container_name: test-mysql-backup
        restart: always
        environment:
            - DB_SERVER=172.17.0.1
            - DB_USER=root
            - DB_PORT=3307
            # Once a day 60*24=1440
            - DB_DUMP_FREQ=1440
            # Makes first backup immediatley (Change to midnight after working)
            - DB_DUMP_BEGIN=+0
            - DB_DUMP_SAFECHARS
        env_file:
            - mysql-backup.env


    phpmyadmin:
        container_name: phpmyadmin
        image: 'capacitor-phpmyadmin:latest'
        build: ./dockerfiles/custom-phpmyadmin-container/
        environment:
            # The address 172.17.0.1 is localhost for docker
            - PMA_HOSTS=172.17.0.1,172.17.0.1
            - PMA_PORTS=3306,3307
            - PMA_VERBOSES=prod,test
        restart: always
        ports:
            - '8081:443'
        volumes:
            - '/etc/apache2/ssl:/certs:ro'
        hostname: 'capacitor-archive.com'


    capacitor-gitlab-runner:
        container_name: gitlab-runner
        image: 'capacitor-gitlab-runner:latest'
        build: ./dockerfiles/custom-gitlab-runner-container/
        restart: always
        volumes:
            - '/var/run/docker.sock:/var/run/docker.sock'
            - 'gitlab-runner-config:/etc/gitlab-runner'
            - 'test-client-build:/home/gitlab-runner/test-client/'
            - 'test-server-build:/home/gitlab-runner/test-server/'
            - 'prod-client-build:/home/gitlab-runner/prod-client/'
            - 'prod-server-build:/home/gitlab-runner/prod-server/'



#########################
# Deployment Environments
#########################


    testClient:
        container_name: test-client
        image: 'httpd-custom-config:latest'
        build: ./dockerfiles/custom-httpd-container/
        restart: always
        ports:
            - '35506:80'
        volumes:
            - 'test-client-build:/usr/local/apache2/htdocs/'


    testServer:
        container_name: test-server
        image: 'tomcat:9.0'
        restart: always
        ports:
            - '35505:8080'
        depends_on:
            - testDatabase
        environment:
            - JAVA_OPTS=-Dspring.profiles.active=dev
        volumes:
            - 'test-server-build:/usr/local/tomcat/webapps/'


    prodClient:
        container_name: prod-client
        image: 'httpd-custom-config:latest'
        build: ./dockerfiles/custom-httpd-container/
        restart: always
        ports:
            - '35504:80'
        volumes:
            - 'prod-client-build:/usr/local/apache2/htdocs/'


    prodServer:
        container_name: prod-server
        image: 'tomcat:9.0'
        restart: always
        ports:
            - '35503:8080'
        depends_on:
            - prodDatabase
        environment:
            - JAVA_OPTS=-Dspring.profiles.active=prod
        volumes:
            - 'prod-server-build:/usr/local/tomcat/webapps/'




volumes:
    gitlab-runner-config:
        external: false
    test-client-build:
        external: false
    test-server-build:
        external: false
    prod-client-build:
        external: false
    prod-server-build:
        external: false
